Simplest path to calculating biomass using census data and allodb
================
Mauro Lepore
2018-11-06

Packages.

``` r
library(tidyverse)
library(here)
library(bmss)
library(allodb)
```

Helpers.

``` r
# List all datasets of a package.
datasets <- function(package) {
  sort(utils::data(package = package)$results[ , "Item"])
}

compare_names <- function(x, y) {
  list(x, y) %>% 
    purrr::map(names) %>% 
    purrr::reduce(setdiff)
}

add_species <- function(.census, .species) {
  suppressMessages({
    .species %>% 
      tidyr::unite("species", Genus, Species, sep = " ") %>% 
      dplyr::select(species, sp) %>% 
      dplyr::right_join(.census)
  })
}

add_site <- function(.census, site) {
  found_site <- grep(site, allodb::sites_info$site, ignore.case = TRUE, value = TRUE)
  if (identical(length(found_site), 0)) {
    rlang::abort( glue::glue("Can't find any site mathing {site}."))
  }
  
  rlang::inform(glue::glue("Using site {rlang::expr_label(found_site)}."))
  tibble::add_column(.census, site = found_site)
}
```

### Database data

All datasets.

``` r
datasets("allodb")
#>  [1] "equations"               "equations_metadata"     
#>  [3] "missing_values_metadata" "references_metadata"    
#>  [5] "scbi_species"            "scbi_stem1"             
#>  [7] "scbi_stem2"              "scbi_tree1"             
#>  [9] "scbi_tree2"              "sites_info"             
#> [11] "sitespecies"             "sitespecies_metadata"   
#> [13] "wsg"                     "wsg_metadata"
```

The core table of **allodb** is `equaitons`.

``` r
glimpse(equations)
#> Observations: 168
#> Variables: 22
#> $ equation_id                          <chr> "2060ea", "a4d879", "c59e...
#> $ equation_form                        <chr> "10^(a+b*(log10(DBH^c)))"...
#> $ equation_allometry                   <chr> "10^(1.1891+1.419*(log10(...
#> $ dependent_variable_biomass_component <chr> "Total aboveground biomas...
#> $ independent_variable                 <chr> "DBH", "DBH", "DBH", "DBH...
#> $ allometry_specificity                <chr> "Species", "Species", "Ge...
#> $ geographic_area                      <chr> "Ohio, USA", "Ohio, USA",...
#> $ dbh_min_cm                           <chr> "0.21", "0.19", "8.9", "5...
#> $ dbh_max_cm                           <chr> "5.73", "3.86", "25.4", "...
#> $ sample_size                          <chr> NA, NA, NA, NA, NA, NA, "...
#> $ dbh_units_original                   <chr> "cm", "cm", "cm", "in", "...
#> $ biomass_units_original               <chr> "g", "g", "g", "g", "g", ...
#> $ allometry_development_method         <chr> "harvest", "harvest", "ha...
#> $ regression_model                     <chr> NA, NA, NA, NA, NA, NA, "...
#> $ other_equations_tested               <chr> NA, NA, NA, NA, NA, NA, N...
#> $ log_biomass                          <chr> NA, NA, NA, NA, NA, NA, "...
#> $ bias_corrected                       <chr> "1", "1", "1", "0", "0", ...
#> $ bias_correction_factor               <chr> "1.056", "1.016", "includ...
#> $ notes_fitting_model                  <chr> NA, NA, NA, NA, NA, NA, N...
#> $ original_data_availability           <chr> NA, NA, NA, NA, NA, NA, N...
#> $ warning                              <chr> NA, NA, NA, NA, NA, NA, N...
#> $ ref_id                               <chr> NA, NA, NA, NA, NA, NA, N...
```

Some equaitons need to be fixed. Here we’ll use the good ones.

``` r
good_equations <- drop_bad_equations(equations)

# Compare
list(good_equations, equations) %>% 
  map_dbl(nrow) %>% 
  set_names(c("n_good", "n_all"))
#> n_good  n_all 
#>    135    168
```

`master()` combines multiple database tables. Glimpse excluding
problematic equations.

``` r
master() %>% 
  drop_bad_equations() %>% 
  glimpse()
#> Observations: 594
#> Variables: 44
#> $ equation_id                          <chr> "2060ea", "2060ea", "a4d8...
#> $ equation_form                        <chr> "10^(a+b*(log10(DBH^c)))"...
#> $ equation_allometry                   <chr> "10^(1.1891+1.419*(log10(...
#> $ dependent_variable_biomass_component <chr> "Total aboveground biomas...
#> $ independent_variable                 <chr> "DBH", "DBH", "DBH", "DBH...
#> $ allometry_specificity                <chr> "Species", "Species", "Sp...
#> $ geographic_area                      <chr> "Ohio, USA", "Ohio, USA",...
#> $ dbh_min_cm                           <chr> "0.21", "0.21", "0.19", "...
#> $ dbh_max_cm                           <chr> "5.73", "5.73", "3.86", "...
#> $ sample_size                          <chr> NA, NA, NA, NA, NA, NA, N...
#> $ dbh_units_original                   <chr> "cm", "cm", "cm", "cm", "...
#> $ biomass_units_original               <chr> "g", "g", "g", "g", "g", ...
#> $ allometry_development_method         <chr> "harvest", "harvest", "ha...
#> $ regression_model                     <chr> NA, NA, NA, NA, NA, NA, N...
#> $ other_equations_tested               <chr> NA, NA, NA, NA, NA, NA, N...
#> $ log_biomass                          <chr> NA, NA, NA, NA, NA, NA, N...
#> $ bias_corrected                       <chr> "1", "1", "1", "1", "1", ...
#> $ bias_correction_factor               <chr> "1.056", "1.056", "1.016"...
#> $ notes_fitting_model                  <chr> NA, NA, NA, NA, NA, NA, N...
#> $ original_data_availability           <chr> NA, NA, NA, NA, NA, NA, N...
#> $ warning                              <chr> NA, NA, NA, NA, NA, NA, N...
#> $ ref_id                               <chr> NA, NA, NA, NA, NA, NA, N...
#> $ site                                 <chr> "Lilly Dicky", "Tyson", "...
#> $ family                               <chr> "Sapindaceae", "Sapindace...
#> $ species                              <chr> "Acer rubrum", "Acer rubr...
#> $ species_code                         <chr> "316", "acerub", "318", "...
#> $ life_form                            <chr> "Tree", "Tree", "Tree", "...
#> $ equation_group                       <chr> "E", "E", "E", "E", "E", ...
#> $ equation_taxa                        <chr> "Acer rubrum", "Acer rubr...
#> $ proxy_species                        <chr> NA, NA, NA, NA, NA, NA, N...
#> $ notes_on_species                     <chr> NA, NA, NA, NA, NA, NA, N...
#> $ wsg_id                               <chr> NA, NA, NA, NA, NA, NA, N...
#> $ wsg_specificity                      <chr> NA, NA, NA, NA, NA, NA, N...
#> $ id                                   <chr> NA, NA, NA, NA, NA, NA, N...
#> $ Site                                 <chr> NA, NA, NA, NA, NA, NA, N...
#> $ lat                                  <chr> NA, NA, NA, NA, NA, NA, N...
#> $ long                                 <chr> NA, NA, NA, NA, NA, NA, N...
#> $ UTM_Zone                             <chr> NA, NA, NA, NA, NA, NA, N...
#> $ UTM_X                                <chr> NA, NA, NA, NA, NA, NA, N...
#> $ UTM_Y                                <chr> NA, NA, NA, NA, NA, NA, N...
#> $ intertropical                        <chr> NA, NA, NA, NA, NA, NA, N...
#> $ size.ha                              <chr> NA, NA, NA, NA, NA, NA, N...
#> $ E                                    <chr> NA, NA, NA, NA, NA, NA, N...
#> $ wsg.site.name                        <chr> NA, NA, NA, NA, NA, NA, N...
```

### Census data

Census.

``` r
glimpse(scbi_tree1)
#> Observations: 40,283
#> Variables: 20
#> $ treeID    <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 1...
#> $ stemID    <int> 1, 2, 3, 4, 5, 6, 7, 8, 9, 10, 11, 12, 13, 14, 15, 1...
#> $ tag       <chr> "10079", "10168", "10567", "12165", "12190", "12192"...
#> $ StemTag   <chr> "1", "1", "1", "1", "1", "1", "1", "1", "1", "1", "1...
#> $ sp        <chr> "libe", "libe", "libe", "nysy", "havi", "havi", "unk...
#> $ quadrat   <chr> "0104", "0103", "0110", "0122", "0122", "0122", "012...
#> $ gx        <dbl> 3.7, 17.3, 9.0, 14.2, 9.4, 1.3, 17.8, 18.0, 18.0, 5....
#> $ gy        <dbl> 73.00, 58.90, 197.10, 428.50, 436.40, 434.00, 447.10...
#> $ DBHID     <int> 1, 3, 5, 7, 9, 13, 15, 17, 19, 22, 24, 26, 28, 31, 3...
#> $ CensusID  <int> 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1, 1...
#> $ dbh       <dbl> 27.9, 23.7, 22.2, 135.0, 87.0, 22.5, 42.6, 51.4, 38....
#> $ pom       <chr> "1.3", "1.3", "1.3", "1.3", "1.3", "1.3", "1.3", "1....
#> $ hom       <dbl> 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1.3, 1....
#> $ ExactDate <chr> "2008-10-21", "2008-10-21", "2008-10-22", "2008-09-0...
#> $ DFstatus  <chr> "alive", "alive", "alive", "alive", "alive", "alive"...
#> $ codes     <chr> "M", "M,X", "M", "M", "M", "M", "D,M,Q", "M,P,lost",...
#> $ nostems   <dbl> 2, 2, 2, 2, 4, 2, 2, 2, 3, 2, 2, 2, 3, 3, 2, 4, 14, ...
#> $ date      <dbl> 17826, 17826, 17827, 17783, 17783, 17783, 17783, 177...
#> $ status    <chr> "A", "A", "A", "A", "A", "A", "D", "A", "A", "A", "A...
#> $ agb       <dbl> 0.0015863427, 0.0009740233, 0.0009880680, 0.12360288...
```

This dataset is not structured exactly as a reference dataset from
Luquillo but the difference is irrelevant to calculating biomass. The
column `agb` is not useful and `DBHID` is equivalent to `MeasureID`.

``` r
reference_tree <- fgeo.data::luquillo_tree5_random

# In scbi but not luquillo
compare_names(scbi_tree1, reference_tree)
#> [1] "DBHID" "agb"
# In luquillo but not scbi
compare_names(reference_tree, scbi_tree1)
#> [1] "MeasureID"
```

Let’s add columns `site` and `species`.

FIXME: Wrap into a single `add_site_sp()` function, or
`prepare_census()`, or `as_allodb_census()` (with corresponding
`new_allodb_census()`, and `validate_allodb_census()` – which is
responsible to check stuff that then no longer needs to be checked
downstream in **bmss**)?

``` r
scbi <- scbi_tree1 %>% 
  add_species(scbi_species) %>% 
  add_site(site = "SCBI")
#> Using site "scbi".

scbi %>% select(site, species, everything())
#> # A tibble: 40,283 x 22
#>    site  species sp    treeID stemID tag   StemTag quadrat    gx    gy
#>    <chr> <chr>   <chr>  <int>  <int> <chr> <chr>   <chr>   <dbl> <dbl>
#>  1 scbi  Linder~ libe       1      1 10079 1       0104     3.70  73  
#>  2 scbi  Linder~ libe       2      2 10168 1       0103    17.3   58.9
#>  3 scbi  Linder~ libe       3      3 10567 1       0110     9    197. 
#>  4 scbi  Nyssa ~ nysy       4      4 12165 1       0122    14.2  428. 
#>  5 scbi  Hamame~ havi       5      5 12190 1       0122     9.40 436. 
#>  6 scbi  Hamame~ havi       6      6 12192 1       0122     1.30 434  
#>  7 scbi  Uniden~ unk        7      7 12212 1       0123    17.8  447. 
#>  8 scbi  Linder~ libe       8      8 12261 1       0125    18    484. 
#>  9 scbi  Viburn~ vipr       9      9 12456 1       0130    18    598. 
#> 10 scbi  Asimin~ astr      10     10 12551 1       0132     5.60 628. 
#> # ... with 40,273 more rows, and 12 more variables: DBHID <int>,
#> #   CensusID <int>, dbh <dbl>, pom <chr>, hom <dbl>, ExactDate <chr>,
#> #   DFstatus <chr>, codes <chr>, nostems <dbl>, date <dbl>, status <chr>,
#> #   agb <dbl>
```

FIXME: Modify `get_allometry()`:

  - Use `master()` by default.
  - Rename as needed:
      - `eqn` = `equation_allometry`,
      - `eqn_source` = `eqn_source`
      - `eqn_type` = `allometry_specificity`

<!-- end list -->

``` r
get_allometry(scbi, "site", "species", "dbh")
#> You gave no custom equations.
#>   * Using default equations.
#> # A tibble: 40,283 x 6
#>    site  sp                     dbh eqn   eqn_source eqn_type
#>    <chr> <chr>                <dbl> <chr> <chr>      <chr>   
#>  1 scbi  Lindera benzoin       27.9 <NA>  <NA>       <NA>    
#>  2 scbi  Lindera benzoin       23.7 <NA>  <NA>       <NA>    
#>  3 scbi  Lindera benzoin       22.2 <NA>  <NA>       <NA>    
#>  4 scbi  Nyssa sylvatica      135   <NA>  <NA>       <NA>    
#>  5 scbi  Hamamelis virginiana  87   <NA>  <NA>       <NA>    
#>  6 scbi  Hamamelis virginiana  22.5 <NA>  <NA>       <NA>    
#>  7 scbi  Unidentified unk      42.6 <NA>  <NA>       <NA>    
#>  8 scbi  Lindera benzoin       51.4 <NA>  <NA>       <NA>    
#>  9 scbi  Viburnum prunifolium  38.3 <NA>  <NA>       <NA>    
#> 10 scbi  Asimina triloba       14.5 <NA>  <NA>       <NA>    
#> # ... with 40,273 more rows
```

Run with a general category. Then update **bmss** to deal with all other
categories.

``` r
master()$allometry_specificity %>% unique()
#> [1] "Species"        "Genus"          "Mixed hardwood" "Family"        
#> [5] "Woody species"  NA
```
