---
output: github_document
---

<!-- README.md is generated from README.Rmd. Please edit that file -->

```{r setup, echo = FALSE, message=FALSE, warning=FALSE}
set.seed(1014)

knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE
)
```

# <img src="https://i.imgur.com/39pvr4n.png" align="right" height=44 /> allodb: Database of allometric equations

[![lifecycle](https://img.shields.io/badge/lifecycle-experimental-orange.svg)](https://www.tidyverse.org/lifecycle/#experimental)
[![Travis build status](https://travis-ci.org/forestgeo/allodb.svg?branch=master)](https://travis-ci.org/forestgeo/allodb)
[![Coverage status](https://coveralls.io/repos/github/forestgeo/allodb/badge.svg)](https://coveralls.io/r/forestgeo/allodb?branch=master)
[![CRAN status](https://www.r-pkg.org/badges/version/allodb)](https://cran.r-project.org/package=allodb)

The goal of allodb is to develop, host and give access to tables of allometric equations for ForestGEO's network.

## Installation

```
# install.packages("remotes")
remotes::install_github("forestgeo/allodb", auth_token = "abc")
```

For details in how to install packages from GitHub see [this article](https://fgeo.netlify.com/2018/02/05/2018-02-05-installing-packages-from-github/).


## Plan

* TODO: Move to new package __fgeo.biomass__

* TODO: Rename/refactor so the pipeline becomes:

```R
<census> %>% 
  # May be a new class of object defined in fgeo.tool, and reexported by allo
  add_species(<species>) %>%      # from census_species()
  
  # Could include an argument `default_eqn` to use different default equations,
  # e.g. different versions of allodb stored in allodb.
  allo_find() %>%         # from get_equations()
  <allo_customize()> %>%  # New: Inserts custom equations
  allo_prioritize()       # from pick_best_equations()
  allo_evaluate()         # biomass?
```

* TODO: Rename column from sp to species.

* TODO: Document when a function creates or uses an S3 class.



ENHANCEMENTS

* TODO: add_species may be a generic with methods for census and vft -- which
should be classified from reading with read_censuses, as_censuses.

* Add class vft and taxa to read_vft() and read_taxa().

* Add methods for filter() (and maybe the other 4 main verbes) so that new
classes aren't dropped.







## Example

This example shows how to to calculate biomass using ForestGEO-like census data and allometric equations from the __allodb__ package.

```{r, message=FALSE}
library(allodb)
# General purpose tools
library(dplyr)
```

Create a dataset with information on the dbh and latin species name.

```{r}
dbh_species <- census_species(allodb::scbi_tree1, allodb::scbi_species, "scbi")
dbh_species
```

```{r}
eqn <- get_equations(dbh_species)
eqn
```

```{r}
best <- pick_best_equations(eqn)
best
```

Deal with duplicated equations

```{r}
find_duplicated_rowid(best)
```

```{r}
# NO duplicated rowid
eqn_1rowid <- pick_one_row_by_rowid(best)
eqn_1rowid

find_duplicated_rowid(eqn_1rowid)
```

Now you may add the equations to the census data.

```{r}
census_equations <- left_join(dbh_species, eqn_1rowid)
census_equations
```

```{r}
nrow(census_equations)
# Same 
nrow(allodb::scbi_tree1)
# Not the same 
nrow(eqn_1rowid)
```

Finally you can evaluate the equations in the context of `dbh`.

```{r}
biomass <- evaluate_equations(census_equations)
biomass
```

And you can summarize the result with __dplyr__ or any other tool.

```{r}
biomass %>% 
  group_by(sp) %>% 
  summarize(biomass = sum(biomass, na.rm = TRUE))
```

