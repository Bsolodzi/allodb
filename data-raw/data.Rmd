---
title: "Gather raw data,clean it and export it to  data/"
output: github_document
---

# Overview

This document exports data. It takes data from data-raw/, cleans it, and places a .rda version of it in data/. To update all exported data you can do either of two things: (1) Click Knit (Ctrl+Shift+K), which will also update data.md, or (2) Run > Run All (Ctrl+Alt+R). You can also update the data in specific code chunks. (Learn more about RMarkdown documents [here](https://rmarkdown.rstudio.com/lesson-1.html).)

# Setup

```{r setup, include=FALSE}
knitr::opts_chunk$set(
  comment = "#>",
  collapse = TRUE,
  echo = TRUE
)
```

```{r}
library(allodb)
library(tidyverse)
library(here)
library(usethis)
```

# Gather raw master data

```{r master}
master <- read_csv_as_chr(here("data-raw/allodb_master.csv"))
```

# Add `equaion_id` to master

## Create random values of `equation_id`

Create a unique id for each equation already in the database

```
# WARNING
# This chunk should not be re-run. If you re-run it, you will change the random
# id of each equation
equation_allometry <- unique(master$equation_allometry)
allometry_id <- tibble::tibble(
  equation_allometry = equation_allometry,
  equation_id = ids::random_id(length(equation_allometry), bytes = 3)
)
write_csv(allometry_id, here("data-raw/allometry_id.csv"))
```

## Add the equation ids to `master`

Right now, all values of `equation_id` in `master` are missing:

```{r show-master-id}
any(!is.na(master$equation_id))

master %>% 
  select(equation_allometry, equation_id)
```

Fill `equation_id`s:

```{r}
allometry_id <- read_csv(here("data-raw/allometry_id.csv"))
master_id <- master %>% 
  select(-equation_id) %>%
  left_join(allometry_id)
```

Confirm that `equation_id` has no missing value.

```{r}
any(is.na(master_id$equation_id))

master_id %>% 
  select(equation_allometry, equation_id)
```

## How to allocate `equation_id` to new equations

If you need a new random id for a new equation, you can pick one from `data-raw/available_random_ids.csv` and delete it from that file.

# Export subsets of master data

This section exports subsets of the clean master data to data/. Each dataset documented in R/data.R to produce a help file that can be accessed from the R console with `?name-of-the-dataset` and also from the Functions Index tab of the website of __allodb__.

## `equations`

Allometric equations (doesn't include sites, but sp? not sure)

```{r equations}
equations_cols <- c(
  "equation_id",
  "equation_form",
  "equation_allometry",
  "dependent_variable_biomass_component",
  "independent_variable",
  "allometry_specificity",
  "geographic_area",
  "dbh_min_cm",
  "dbh_max_cm",
  "sample_size",
  "dbh_units_original",
  "biomass_units_original",
  "allometry_development_method",
  "regression_model",
  "other_equations_tested",
  "log_biomass",
  "bias_corrected",
  "bias_correction_factor",
  "notes_fitting_model",
  "original_data_availability",
  "warning",
  "ref_id"
)
equations <- master_id[equations_cols] %>% 
  unique() %>% 
  as.tibble()
use_data(equations, overwrite = TRUE)

equations_metadata <- read_csv(
  here("data-raw/data_equations_metadata.csv")
)
use_data(equations_metadata, overwrite = TRUE)
```

## `missing_values`

```{r missing-values}
missing_values_metadata <- read_csv(
  here("data-raw/data_missing_values_metadata.csv")
)
use_data(missing_values_metadata, overwrite = TRUE)
```

## `references`

References (links to wood density table with an id, my raw reference table includes sites for my own sanity!).

```{r references}
# TODO: Add table.

references_metadata <- read_csv(
  here("data-raw/data_references_metadata.csv")
)
use_data(references_metadata, overwrite = TRUE)
```

## `sites_info`

```{r sites-info}
sites_info <- read_csv(
  here("data-raw/data_sites_info.csv")
)
use_data(sites_info, overwrite = TRUE)
```

## `sitespecies`

Site-species (includes non-tropical sites, links to equation table with eq Id).

```{r sitespecies}
sitespecies_cols <- c(
  "site",
  "family",
  "species",
  "species_code",
  "life_form",
  "dependent_variable_biomass_component",
  "equation_grouping",
  "equation_id",
  "allometry_specificity",
  "proxy_species",
  "dbh_min_cm",
  "dbh_max_cm",
  "notes_on_species",
  "wsg_id",
  "wsg_specificity"
)
sitespecies <- master_id[sitespecies_cols] %>% 
  unique() %>% 
  as.tibble()
use_data(sitespecies, overwrite = TRUE)

sitespecies_metadata <- read_csv(
  here("data-raw/data_sitespecies_metadata.csv")
)
use_data(sitespecies_metadata, overwrite = TRUE)
```

## `wsg`

Wood density (with this scrip and master table we only take wsg for temperate sites, later to be merge with trop).

```{r wsg}
wsg_cols <- c(
  "wsg_id",
  "family",
  "species",
  "wsg",
  "wsg_specificity",
  "sample_size",
  "site",
  "ref_id"
)
wsg <- master_id[wsg_cols] %>% 
  unique() %>% 
  as.tibble()
use_data(wsg, overwrite = TRUE)

wsg_metadata <- read_csv(
  here("data-raw/data_wsg_metadata.csv")
)
use_data(wsg_metadata, overwrite = TRUE)
```

